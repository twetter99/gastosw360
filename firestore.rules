rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================================
    // FUNCIONES HELPER - USANDO CUSTOM CLAIMS (Sin lecturas extra)
    // ============================================================
    
    // Verifica si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Obtiene el rol del token (Custom Claim - coste $0, latencia 0)
    function getRol() {
      return request.auth.token.rol;
    }
    
    // Verifica el rol del usuario usando Custom Claims
    function hasRole(role) {
      return isAuthenticated() && getRol() == role;
    }
    
    // Verifica si tiene alguno de los roles
    function hasAnyRole(roles) {
      return isAuthenticated() && getRol() in roles;
    }
    
    // Verifica si es admin o dirección
    function isAdminOrDireccion() {
      return hasAnyRole(['admin', 'direccion']);
    }
    
    // Verifica si puede aprobar gastos
    function canApproveExpenses() {
      return hasAnyRole(['supervisor_oficina', 'direccion', 'admin']);
    }
    
    // Verifica si es el propietario del recurso
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verifica si es el aprobador asignado para horas
    function isHoursApprover(aprobadorId) {
      return isAuthenticated() && request.auth.uid == aprobadorId;
    }
    
    // ============================================================
    // VALIDACIÓN DE DATOS - Prevenir inyección de estados
    // ============================================================
    
    // Valida que el estado inicial de horas sea 'borrador'
    function validarEstadoInicialHoras() {
      return request.resource.data.estadoHorasExtras == 'borrador';
    }
    
    // Valida que el estado inicial de gastos sea 'borrador'
    function validarEstadoInicialGastos() {
      return request.resource.data.estadoGasto == 'borrador';
    }
    
    // Valida que el importe sea un número positivo
    function validarImporte() {
      return request.resource.data.importe is number && 
             request.resource.data.importe >= 0;
    }
    
    // Valida que las horas sean un número válido (0-24)
    function validarHoras() {
      return request.resource.data.horasExtras is number && 
             request.resource.data.horasExtras >= 0 &&
             request.resource.data.horasExtras <= 24;
    }
    
    // ============================================================
    // USUARIOS
    // ============================================================
    
    match /usuarios/{userId} {
      // Lectura: autenticados pueden leer usuarios
      allow read: if isAuthenticated();
      
      // Crear: solo admin puede crear usuarios
      allow create: if hasAnyRole(['admin', 'direccion']);
      
      // Actualizar: admin puede editar todo, usuario solo perfil básico
      allow update: if hasAnyRole(['admin', 'direccion']) ||
        (isOwner(userId) && onlyUpdatingAllowedFields());
      
      // Eliminar: solo admin
      allow delete: if hasRole('admin');
      
      // Helper para verificar que solo actualiza campos permitidos
      function onlyUpdatingAllowedFields() {
        let allowedFields = ['telefono', 'avatar', 'preferencias'];
        let changedFields = request.resource.data.diff(resource.data).affectedKeys();
        return changedFields.hasOnly(allowedFields);
      }
    }
    
    // ============================================================
    // REGISTROS DE HORAS
    // ============================================================
    
    match /registrosHoras/{registroId} {
      // Lectura:
      // - Propietario puede ver los suyos
      // - Aprobador asignado puede ver
      // - Jefe de equipo, Supervisor/Dirección/Admin pueden ver todos
      allow read: if isAuthenticated() && (
        isOwner(resource.data.usuarioId) ||
        isHoursApprover(resource.data.aprobadorHorasId) ||
        hasAnyRole(['jefe_equipo', 'supervisor_oficina', 'direccion', 'admin'])
      );
      
      // Crear: usuario autenticado puede crear sus propios registros
      // VALIDACIÓN CRÍTICA: Estado DEBE ser 'borrador', horas válidas
      allow create: if isAuthenticated() && 
        request.resource.data.usuarioId == request.auth.uid &&
        validarEstadoInicialHoras() &&
        validarHoras();
      
      // Actualizar:
      // - Propietario puede editar si está en borrador (no puede auto-aprobar)
      // - Aprobador puede cambiar estado a aprobado/rechazado/devuelto
      // - Admin puede editar todo
      allow update: if isAuthenticated() && (
        // Propietario edita borrador → solo puede pasar a pendiente, no a aprobado
        (isOwner(resource.data.usuarioId) && 
         resource.data.estadoHorasExtras == 'borrador' &&
         request.resource.data.estadoHorasExtras in ['borrador', 'pendiente']) ||
        // Aprobador asignado puede aprobar/rechazar/devolver
        (isHoursApprover(resource.data.aprobadorHorasId) &&
         request.resource.data.estadoHorasExtras in ['aprobado', 'rechazado', 'devuelto']) ||
        // Admin puede todo
        isAdminOrDireccion()
      );
      
      // Eliminar: solo propietario si está en borrador
      allow delete: if isOwner(resource.data.usuarioId) && 
        resource.data.estadoHorasExtras == 'borrador';
    }
    
    // ============================================================
    // GASTOS
    // ============================================================
    
    match /gastos/{gastoId} {
      // Lectura:
      // - Propietario puede ver los suyos
      // - Aprobadores de gastos pueden ver todos
      allow read: if isAuthenticated() && (
        isOwner(resource.data.usuarioId) ||
        canApproveExpenses()
      );
      
      // Crear: usuario autenticado puede crear sus propios gastos
      // VALIDACIÓN CRÍTICA: Estado DEBE ser 'borrador', importe válido
      allow create: if isAuthenticated() && 
        request.resource.data.usuarioId == request.auth.uid &&
        validarEstadoInicialGastos() &&
        validarImporte();
      
      // Actualizar:
      // - Propietario puede editar si está en borrador (no puede auto-aprobar)
      // - Supervisor puede aprobar/rechazar
      allow update: if isAuthenticated() && (
        // Propietario edita borrador → solo puede pasar a pendiente
        (isOwner(resource.data.usuarioId) && 
         resource.data.estadoGasto == 'borrador' &&
         request.resource.data.estadoGasto in ['borrador', 'pendiente']) ||
        // Aprobadores pueden cambiar estado a aprobado/rechazado/devuelto
        (canApproveExpenses() &&
         request.resource.data.estadoGasto in ['aprobado', 'rechazado', 'devuelto']) ||
        // Admin puede todo
        isAdminOrDireccion()
      );
      
      // Eliminar: solo propietario si está en borrador
      allow delete: if isOwner(resource.data.usuarioId) && 
        resource.data.estadoGasto == 'borrador';
    }
    
    // ============================================================
    // DESPLAZAMIENTOS
    // ============================================================
    
    match /desplazamientos/{desplazamientoId} {
      allow read: if isAuthenticated() && (
        isOwner(resource.data.usuarioId) ||
        isAdminOrDireccion() ||
        hasRole('supervisor_oficina')
      );
      
      allow create: if isAuthenticated() && 
        request.resource.data.usuarioId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        isOwner(resource.data.usuarioId) ||
        isAdminOrDireccion()
      );
      
      allow delete: if isOwner(resource.data.usuarioId) || isAdminOrDireccion();
    }
    
    // ============================================================
    // CONFIGURACIÓN (TARIFAS, PROYECTOS, FESTIVOS)
    // ============================================================
    
    match /tarifas/{tarifaId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrDireccion();
    }
    
    match /proyectos/{proyectoId} {
      allow read: if isAuthenticated();
      allow write: if hasAnyRole(['admin', 'direccion', 'supervisor_oficina']);
    }
    
    match /festivos/{festivoId} {
      allow read: if isAuthenticated();
      allow write: if isAdminOrDireccion();
    }
    
    // ============================================================
    // RESÚMENES Y KPIS (Solo lectura, se generan por Cloud Functions)
    // ============================================================
    
    match /resumenesMensuales/{resumenId} {
      allow read: if isAuthenticated() && (
        // Propietario puede ver su resumen
        resource.data.usuarioId == request.auth.uid ||
        // Supervisor/Dirección/Admin pueden ver todos
        hasAnyRole(['jefe_equipo', 'supervisor_oficina', 'direccion', 'admin'])
      );
      
      // Solo Cloud Functions puede escribir
      allow write: if false;
    }
    
    match /kpis/{kpiId} {
      allow read: if hasAnyRole(['supervisor_oficina', 'direccion', 'admin']);
      allow write: if false;
    }
    
    // ============================================================
    // APROBACIONES PENDIENTES (Contador por aprobador)
    // ============================================================
    
    match /aprobacionesPendientes/{aprobadorId} {
      allow read: if isAuthenticated() && request.auth.uid == aprobadorId;
      allow write: if false;
    }
  }
}